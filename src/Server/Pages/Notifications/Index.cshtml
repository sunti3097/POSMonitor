@page "/Notifications"
@model POSMonitor.Server.Pages.Notifications.IndexModel
@{
    ViewData["Title"] = "Notifications";
}

<div class="page-header">
    <h2 class="page-subtitle">Notification Settings</h2>
    <p class="page-description">Configure notifications via Email and Microsoft Teams</p>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

<div class="grid-2">
    <!-- Email Configuration -->
    <div class="panel">
        <div class="panel-header">
            <h3 class="panel-title">üìß Email Settings (SMTP)</h3>
        </div>
        <div class="panel-body">
            <form method="post" asp-page-handler="SaveEmail" class="notify-form">
                <div class="form-check">
                    <input type="checkbox" asp-for="EnableEmail" class="form-check-input" />
                    <label>Enable Email Notifications</label>
                </div>
                <div class="form-group">
                    <label>SMTP Server</label>
                    <input type="text" asp-for="SmtpServer" class="form-control" placeholder="smtp.gmail.com" />
                </div>
                <div class="form-group">
                    <label>SMTP Port</label>
                    <input type="number" asp-for="SmtpPort" class="form-control" placeholder="587" />
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" asp-for="SmtpUsername" class="form-control" placeholder="email@domain.com" />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" asp-for="SmtpPassword" class="form-control" placeholder="Password" />
                </div>
                <div class="form-group">
                    <label>From Email</label>
                    <input type="email" asp-for="EmailFrom" class="form-control" placeholder="noreply@company.com" />
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="submit" formaction="/Notifications?handler=TestEmail" class="btn btn-secondary">Test Send</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MS Teams Configuration -->
    <div class="panel">
        <div class="panel-header">
            <h3 class="panel-title">üí¨ Microsoft Teams Webhook</h3>
        </div>
        <div class="panel-body">
            <form method="post" asp-page-handler="SaveTeams" class="notify-form">
                <div class="form-check">
                    <input type="checkbox" asp-for="EnableTeams" class="form-check-input" />
                    <label>Enable MS Teams Notifications</label>
                </div>
                <div class="form-group">
                    <label>Webhook URL</label>
                    <input type="url" asp-for="TeamsWebhookUrl" class="form-control" 
                           placeholder="https://outlook.office.com/webhook/..." />
                    <small class="form-text">Create an Incoming Webhook from Teams channel settings</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="submit" formaction="/Notifications?handler=TestTeams" class="btn btn-secondary">Test Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Group Notification Schedule -->
<div class="panel">
    <div class="panel-header">
        <h3 class="panel-title">‚è∞ Notification Schedule by Group</h3>
    </div>
    <div class="panel-body">
        @if (!Model.Groups.Any())
        {
            <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <p>No device groups available. Please create a group first.</p>
                <a href="/Groups" class="btn btn-primary">Go to Device Groups</a>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Group</th>
                            <th>Company Code</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Active Days</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var group in Model.Groups)
                        {
                            var config = Model.Configs.FirstOrDefault(c => c.GroupId == group.Id);
                            <tr>
                                <td><div class="cell-title">@group.Name</div></td>
                                <td>
                                    @if (!string.IsNullOrEmpty(group.CompanyCode))
                                    {
                                        <span class="badge badge-company">@group.CompanyCode</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td>@(config?.StartHour.ToString() ?? "-"):00</td>
                                <td>@(config?.EndHour.ToString() ?? "-"):00</td>
                                <td>@(config?.DaysOfWeek ?? "Every day")</td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="showScheduleModal('@group.Id', '@group.Name', @(config?.StartHour ?? 0), @(config?.EndHour ?? 23))">
                                        Configure
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Notification Schedule: <span id="modalGroupName"></span></h3>
        <form method="post" asp-page-handler="SaveSchedule">
            <input type="hidden" asp-for="ScheduleGroupId" id="modalGroupId" />
            
            <div class="form-group">
                <label>Start Time (Hour)</label>
                <input type="number" asp-for="ScheduleStartHour" id="modalStartHour" class="form-control" min="0" max="23" required />
            </div>
            <div class="form-group">
                <label>End Time (Hour)</label>
                <input type="number" asp-for="ScheduleEndHour" id="modalEndHour" class="form-control" min="0" max="23" required />
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideScheduleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
.page-header{margin-bottom:24px}
.page-subtitle{font-size:1.25rem;font-weight:700;color:var(--text);margin-bottom:4px}
.page-description{color:var(--text-muted);font-size:0.9rem}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:12px}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border)}
.panel-title{font-size:1rem;font-weight:600;color:var(--text);margin:0}
.panel-body{padding:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:0.8rem;font-weight:600;color:var(--text-muted);margin-bottom:6px}
.form-control{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--bg);font-size:0.9rem;color:var(--text);box-sizing:border-box}
.form-control:focus{border-color:var(--purple-400);outline:none;box-shadow:0 0 0 3px var(--purple-100)}
.form-check{display:flex;align-items:center;gap:8px;margin-bottom:16px}
.form-check-input{width:18px;height:18px;cursor:pointer}
.form-text{font-size:0.75rem;color:var(--text-muted);margin-top:4px}
.form-actions{display:flex;gap:12px;margin-top:20px}
.btn{padding:10px 20px;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:var(--purple-600);color:white}
.btn-primary:hover{background:var(--purple-700)}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--purple-50)}
.btn-sm{padding:6px 12px;font-size:0.8rem}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:20px}
.alert-success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
.data-table{width:100%;border-collapse:collapse}
.data-table th{padding:12px 16px;text-align:left;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);background:var(--purple-50);border-bottom:1px solid var(--border)}
.data-table td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:0.9rem;color:var(--text)}
.data-table tbody tr:hover{background:var(--purple-50)}
.cell-title{font-weight:600;color:var(--text)}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600}
.badge-company{background:var(--purple-100);color:var(--purple-700)}
.text-muted{color:var(--text-muted)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
.empty-state-icon{font-size:2.5rem;margin-bottom:12px}
.table-responsive{overflow-x:auto}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100}
.modal-content{background:var(--surface);padding:24px;border-radius:12px;min-width:350px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
</style>

<script>
    function showScheduleModal(groupId, groupName, startHour, endHour) {
        document.getElementById('modalGroupId').value = groupId;
        document.getElementById('modalGroupName').textContent = groupName;
        document.getElementById('modalStartHour').value = startHour || 0;
        document.getElementById('modalEndHour').value = endHour || 23;
        document.getElementById('scheduleModal').style.display = 'flex';
    }
    
    function hideScheduleModal() {
        document.getElementById('scheduleModal').style.display = 'none';
    }
</script>
