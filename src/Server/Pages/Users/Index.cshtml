@page "/Users"
@model POSMonitor.Server.Pages.Users.IndexModel
@{
    ViewData["Title"] = "User Management";
}

<div class="page-header">
    <h2 class="page-subtitle">Manage Users & Passwords</h2>
    <p class="page-description">Add, remove, and manage system user permissions</p>
</div>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

<div class="panel">
    <div class="panel-header">
        <h3 class="panel-title">Add New User</h3>
    </div>
    <div class="panel-body">
        <form method="post" asp-page-handler="Create" class="form-inline">
            <div class="form-group">
                <label>Email</label>
                <input type="email" asp-for="NewEmail" class="form-control" placeholder="user@company.com" required />
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" asp-for="NewPassword" class="form-control" placeholder="Password" required />
            </div>
            <div class="form-group">
                <label>Role</label>
                <select asp-for="NewRole" class="form-control">
                    <option value="User">User</option>
                    <option value="Admin">Administrator</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Add User</button>
        </form>
    </div>
</div>

<div class="panel">
    <div class="panel-header">
        <h3 class="panel-title">User List (@Model.Users.Count)</h3>
    </div>
    <div class="panel-body">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Model.Users)
                    {
                        <tr>
                            <td>
                                <div class="cell-title">@user.Email</div>
                                @if (user.IsLockedOut)
                                {
                                    <span class="badge badge-warning">ðŸ”’ Locked</span>
                                }
                            </td>
                            <td>
                                @if (user.Roles.Any())
                                {
                                    @foreach (var role in user.Roles)
                                    {
                                        <span class="badge badge-role @(role == "Admin" ? "badge-admin" : "")">@role</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">No Role</span>
                                }
                            </td>
                            <td>
                                @if (user.IsLockedOut)
                                {
                                    <span class="text-danger">Locked</span>
                                }
                                else
                                {
                                    <span class="text-success">Active</span>
                                }
                            </td>
                            <td>
                                <button type="button" class="btn btn-warning btn-sm" onclick="showResetModal('@user.Id')">Reset Password</button>
                                @if (user.Email != User.Identity?.Name)
                                {
                                    <form method="post" asp-page-handler="Delete" asp-route-id="@user.Id" 
                                          onsubmit="return confirm('Confirm user deletion?');" style="display:inline">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>Reset Password</h3>
        <form method="post" asp-page-handler="ResetPassword" id="resetForm">
            <input type="hidden" name="id" id="resetUserId" />
            <div class="form-group">
                <label>New Password</label>
                <input type="password" name="newPassword" class="form-control" required />
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideResetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
.page-header{margin-bottom:24px}
.page-subtitle{font-size:1.25rem;font-weight:700;color:var(--text);margin-bottom:4px}
.page-description{color:var(--text-muted);font-size:0.9rem}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:20px}
.panel-header{padding:16px 20px;border-bottom:1px solid var(--border)}
.panel-title{font-size:1rem;font-weight:600;color:var(--text)}
.panel-body{padding:20px}
.form-inline{display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group label{font-size:0.8rem;font-weight:600;color:var(--text-muted)}
.form-control{padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--bg);font-size:0.9rem;color:var(--text);min-width:200px}
.btn{padding:10px 20px;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-primary{background:var(--purple-600);color:white}
.btn-primary:hover{background:var(--purple-700)}
.btn-danger{background:var(--danger);color:white}
.btn-danger:hover{background:#dc2626}
.btn-warning{background:var(--warning);color:white}
.btn-warning:hover{background:#d97706}
.btn-sm{padding:6px 12px;font-size:0.8rem}
.data-table{width:100%;border-collapse:collapse}
.data-table th{padding:12px 16px;text-align:left;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);background:var(--purple-50);border-bottom:1px solid var(--border)}
.data-table td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:0.9rem;color:var(--text)}
.data-table tbody tr:hover{background:var(--purple-50)}
.cell-title{font-weight:600;color:var(--text)}
.badge{display:inline-block;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;margin-right:4px}
.badge-role{background:var(--purple-100);color:var(--purple-700)}
.badge-admin{background:#fef3c7;color:#92400e}
.badge-warning{background:var(--warning-light);color:var(--warning)}
.text-success{color:var(--success)}
.text-danger{color:var(--danger)}
.text-muted{color:var(--text-muted)}
.table-responsive{overflow-x:auto}
.alert{padding:12px 16px;border-radius:8px;margin-bottom:20px}
.alert-success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
.alert-danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100}
.modal-content{background:var(--surface);padding:24px;border-radius:12px;min-width:300px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
</style>

<script>
    function showResetModal(userId) {
        document.getElementById('resetUserId').value = userId;
        document.getElementById('resetModal').style.display = 'flex';
    }
    function hideResetModal() {
        document.getElementById('resetModal').style.display = 'none';
    }
</script>
