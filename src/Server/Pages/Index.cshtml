@page
@model POSMonitor.Server.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard";
    var onlineCount = Model.Devices.Count(d => d.Status == POSMonitor.Shared.Enums.DeviceStatus.Online);
}

<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-icon"></div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalDevices</div>
            <div class="stat-label">Total</div>
        </div>
    </div>
    <div class="stat-card success">
        <div class="stat-icon"></div>
        <div class="stat-content">
            <div class="stat-value">@onlineCount</div>
            <div class="stat-label">Online</div>
        </div>
    </div>
    <div class="stat-card warning">
        <div class="stat-icon"></div>
        <div class="stat-content">
            <div class="stat-value">@Model.WarningDevices</div>
            <div class="stat-label">Warning</div>
        </div>
    </div>
    <div class="stat-card danger">
        <div class="stat-icon"></div>
        <div class="stat-content">
            <div class="stat-value">@Model.OfflineDevices</div>
            <div class="stat-label">Offline</div>
        </div>
    </div>
</div>

<div class="filter-bar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search ComName, POS ID, Store..." />
    </div>
    <select class="filter-select" id="companyFilter">
        <option value="">All Companies</option>
        @foreach (var group in Model.GroupBreakdown)
        {
            <option value="@group.Name">@group.Name</option>
        }
    </select>
    <select class="filter-select" id="statusFilter">
        <option value="">All Status</option>
        <option value="online">Online</option>
        <option value="warning">Warning</option>
        <option value="offline">Offline</option>
    </select>
    <div class="view-toggle">
        <button class="view-btn active" data-view="grid" onclick="switchView('grid')">Grid</button>
        <button class="view-btn" data-view="table" onclick="switchView('table')">Table</button>
    </div>
</div>

<div style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">Showing @Model.TotalDevices / @Model.TotalDevices machines</div>

<div id="gridView" class="view-content active">
    <div class="group-section">
        <div class="group-header">
            <div class="group-icon"></div>
            <span class="group-name">All Devices</span>
            <span class="group-count">(@Model.TotalDevices)</span>
        </div>
        <div class="machine-grid">
            @foreach (var device in Model.Devices)
            {
                var statusClass = device.Status.ToString().ToLower();
                var cpu = 0;
                var ram = 0;
                <div class="machine-card @statusClass" data-status="@statusClass">
                    <div class="machine-header">
                        <div class="machine-id">@device.DeviceId</div>
                        <span class="status-badge @statusClass">
                            <span class="status-dot"></span>@device.Status
                        </span>
                    </div>
                    <div class="machine-info">
                        <div class="machine-label">POS @device.DeviceId</div>
                        <div class="machine-value">@(statusClass == "offline" ? " Scheduled Off" : " Running")</div>
                    </div>
                    <div class="machine-metrics">
                        <div>
                            <div class="metric-row"><span class="metric-label">CPU</span><span class="metric-value">@cpu%</span></div>
                            <div class="metric-bar"><div class="metric-bar-fill cpu" style="width: @(cpu)%"></div></div>
                        </div>
                        <div>
                            <div class="metric-row"><span class="metric-label">RAM</span><span class="metric-value">@ram%</span></div>
                            <div class="metric-bar"><div class="metric-bar-fill ram" style="width: @(ram)%"></div></div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div id="tableView" class="view-content">
    <div class="machine-table-container">
        <table class="machine-table">
            <thead>
                <tr>
                    <th>POS ID</th>
                    <th>Name</th>
                    <th>Group</th>
                    <th>IP Address</th>
                    <th>Status</th>
                    <th>CPU %</th>
                    <th>RAM %</th>
                    <th>Last Heartbeat</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var device in Model.Devices)
                {
                    var statusClass = device.Status.ToString().ToLower();
                    var cpu = 0;
                    var ram = 0;
                    <tr data-status="@statusClass">
                        <td class="id-cell">@device.DeviceId</td>
                        <td>@(device.Hostname ?? "POS " + device.DeviceId)</td>
                        <td>@(device.GroupName ?? "-")</td>
                        <td>@(device.IpAddress ?? "-")</td>
                        <td class="status-cell">
                            <span class="status-badge @statusClass"><span class="status-dot"></span>@device.Status</span>
                        </td>
                        <td>@cpu%</td>
                        <td>@ram%</td>
                        <td>@(device.LastHeartbeatAt?.ToLocalTime().ToString("dd/MM/yy HH:mm") ?? "Never")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<script>
    function switchView(view) {
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.view-content').forEach(content => content.classList.remove('active'));
        document.querySelector(`[data-view="${view}"]`).classList.add('active');
        document.getElementById(view + 'View').classList.add('active');
    }
    
    function filterMachines() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        
        document.querySelectorAll('.machine-card, .machine-table tbody tr').forEach(el => {
            const elStatus = el.dataset.status;
            const elText = el.textContent.toLowerCase();
            const matchesSearch = elText.includes(search);
            const matchesStatus = !status || elStatus === status;
            el.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    }
    
    document.getElementById('searchInput').addEventListener('input', filterMachines);
    document.getElementById('companyFilter').addEventListener('change', filterMachines);
    document.getElementById('statusFilter').addEventListener('change', filterMachines);
</script>
