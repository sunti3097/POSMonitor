@page
@model POSMonitor.Server.Pages.IndexModel
@using POSMonitor.Shared.Enums
@{
    ViewData["Title"] = "Dashboard";
    var companies = Model.Devices
        .Where(d => !string.IsNullOrWhiteSpace(d.CompanyCode))
        .Select(d => d.CompanyCode!).Distinct().OrderBy(c => c).ToList();
}

<!-- Stat Bar -->
<div class="stat-grid">
    <div class="stat-card" onclick="setFilter('')" tabindex="0" title="คลิกเพื่อดูทั้งหมด">
        <div class="stat-icon">🖥️</div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalDevices</div>
            <div class="stat-label">ทั้งหมด</div>
        </div>
    </div>
    <div class="stat-card success" onclick="setFilter('online')" tabindex="0" title="คลิกเพื่อดูเฉพาะ Online">
        <div class="stat-icon">🟢</div>
        <div class="stat-content">
            <div class="stat-value">@Model.OnlineDevices</div>
            <div class="stat-label">ONLINE</div>
        </div>
    </div>
    <div class="stat-card warning" onclick="setFilter('degraded')" tabindex="0" title="คลิกเพื่อดูเฉพาะ Warning">
        <div class="stat-icon">⚠️</div>
        <div class="stat-content">
            <div class="stat-value">@Model.WarningDevices</div>
            <div class="stat-label">WARNING</div>
        </div>
    </div>
    <div class="stat-card danger" onclick="setFilter('offline')" tabindex="0" title="คลิกเพื่อดูเฉพาะ Offline">
        <div class="stat-icon">🔴</div>
        <div class="stat-content">
            <div class="stat-value">@Model.OfflineDevices</div>
            <div class="stat-label">OFFLINE</div>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="search-box">
        <svg viewBox="0 0 20 20" fill="currentColor" width="15" height="15" class="search-icon"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"/></svg>
        <input type="text" id="searchInput" placeholder="ค้นหา POS ID, IP, สาขา..." />
    </div>
    <select class="filter-select" id="companyFilter">
        <option value="">ทุกบริษัท</option>
        @foreach (var c in companies) { <option value="@c">บริษัท @c</option> }
    </select>
    <select class="filter-select" id="statusFilter">
        <option value="">ทุกสถานะ</option>
        <option value="online">Online</option>
        <option value="offline">Offline</option>
        <option value="degraded">Warning</option>
    </select>
</div>

<div class="result-bar">
    <span id="resultSummary">แสดง @Model.TotalDevices เครื่อง</span>
    <span class="updated-at">อัปเดต @Model.GeneratedAt.ToLocalTime().ToString("HH:mm:ss")</span>
</div>

<!-- Main Content: Company > Store > POS rows -->
@if (!Model.CompanyGroups.Any())
{
    <div class="empty-state-full">
        <div style="font-size:3rem">🖥️</div>
        <h3>ยังไม่มีเครื่อง POS</h3>
        <p>เครื่อง POS จะปรากฏที่นี่เมื่อ Agent ส่ง heartbeat มาครั้งแรก</p>
    </div>
}
else
{
    @foreach (var company in Model.CompanyGroups)
    {
        <div class="company-block" data-company="@company.CompanyCode">
            <div class="company-heading">
                <span class="company-icon-img">🏢</span>
                <span class="company-title">บริษัท @company.CompanyCode</span>
                <span class="company-meta">@company.Stores.Count สาขา · @company.TotalDevices เครื่อง</span>
            </div>

            <div class="stores-list">
                @foreach (var store in company.Stores)
                {
                    <div class="store-block" data-store="@store.StoreCode">
                        <div class="store-header">
                            <div class="store-title-row">
                                <span class="store-pin">📍</span>
                                <span class="store-name">@(store.GroupName != store.StoreCode ? store.GroupName : $"{company.CompanyCode}-{store.StoreCode}")</span>
                            </div>
                            <div class="store-pills">
                                <span class="pill online">@store.OnlineCount Online</span>
                                <span class="pill offline">@store.OfflineCount Offline</span>
                                <span class="pill total">@store.Devices.Count เครื่อง</span>
                            </div>
                        </div>

                        <div class="pos-rows">
                            @foreach (var device in store.Devices)
                            {
                                var statusRaw = device.Status.ToString().ToLower();
                                var sc = device.Status.ToString().ToLower();
                                var lastTime = device.LastHeartbeatAt?.ToLocalTime().ToString("HH:mm") ?? "--:--";
                                <div class="pos-row @sc"
                                     data-status="@sc"
                                     data-company="@(device.CompanyCode ?? "")"
                                     data-text="@device.DeviceId @device.Hostname @device.IpAddress @device.StoreCode"
                                     onclick="location.href='/Devices/Detail/@device.Id'">
                                    <span class="pos-indicator @sc"></span>
                                    <span class="pos-id">@device.DeviceId</span>
                                    <span class="pos-ip">@(device.IpAddress ?? "-")</span>
                                    @if (!string.IsNullOrEmpty(device.Hostname))
                                    {
                                        <span class="pos-hostname">@device.Hostname</span>
                                    }
                                    else
                                    {
                                        <span class="pos-hostname">-</span>
                                    }
                                    <span class="pos-time">@lastTime</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
}

<style>
/* Result bar */
.result-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;font-size:0.82rem;color:var(--text-muted)}
.updated-at{font-size:0.78rem}

/* Stat Cards click style */
.stat-card{cursor:pointer;transition:transform 0.15s, box-shadow 0.15s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 10px 25px -5px rgba(0,0,0,0.1),0 8px 10px -6px rgba(0,0,0,0.1)}
.stat-card:active{transform:translateY(0)}

/* Empty */
.empty-state-full{text-align:center;padding:60px 20px;color:var(--text-muted)}
.empty-state-full h3{font-size:1.1rem;color:var(--text);margin:12px 0 8px}

/* Company block */
.company-block{margin-bottom:32px}
.company-heading{display:flex;align-items:center;gap:10px;margin-bottom:14px;padding:8px 0 10px;border-bottom:2px solid var(--purple-200)}
.company-icon-img{font-size:1.2rem}
.company-title{font-size:1.05rem;font-weight:700;color:var(--text)}
.company-meta{font-size:0.78rem;color:var(--text-muted);background:var(--purple-50);padding:2px 10px;border-radius:20px;margin-left:4px}

/* Stores list */
.stores-list{display:flex;flex-direction:column;gap:12px}

/* Store block */
.store-block{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.store-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px}
.store-title-row{display:flex;align-items:center;gap:6px}
.store-pin{font-size:1rem}
.store-name{font-size:0.92rem;font-weight:700;color:var(--text)}
.store-pills{display:flex;gap:6px;align-items:center}
.pill{font-size:0.72rem;font-weight:600;padding:3px 10px;border-radius:20px}
.pill.online{background:#dcfce7;color:#166534}
.pill.offline{background:#fee2e2;color:#991b1b}
.pill.total{background:var(--purple-50);color:var(--purple-700)}

/* POS rows */
.pos-rows{display:flex;flex-direction:column}
.pos-row{display:flex;align-items:center;gap:12px;padding:9px 16px;border-bottom:1px solid var(--border);transition:background .15s;font-size:0.85rem;cursor:pointer}
.pos-row:last-child{border-bottom:none}
.pos-row:hover{background:var(--purple-50)}
.pos-row.online{background:linear-gradient(90deg,#f0fdf4 0,var(--surface) 6px)}
.pos-row.offline{background:linear-gradient(90deg,#fff1f2 0,var(--surface) 6px)}
.pos-row.degraded,.pos-row.unknown{background:linear-gradient(90deg,#fffbeb 0,var(--surface) 6px)}

.pos-indicator{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.pos-indicator.online{background:#16a34a;box-shadow:0 0 0 2px #bbf7d0}
.pos-indicator.offline{background:#dc2626;box-shadow:0 0 0 2px #fecaca}
.pos-indicator.degraded,.pos-indicator.unknown{background:#f59e0b;box-shadow:0 0 0 2px #fde68a}

.pos-id{font-weight:700;font-family:monospace;color:var(--text);min-width:80px;font-size:0.88rem}
.pos-ip{flex:1;color:var(--text-muted);font-size:0.82rem;font-family:monospace}
.pos-time{font-size:0.78rem;color:var(--text-muted);font-family:monospace;min-width:40px;text-align:right}
.pos-hostname{font-size:0.75rem;color:var(--text-muted);background:var(--purple-50);padding:2px 8px;border-radius:6px;font-family:monospace;margin-left:auto;margin-right:12px}

/* Search box */
.search-box{position:relative;flex:1}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-muted)}
.search-box input{width:100%;padding:9px 12px 9px 34px;border:1px solid var(--border);border-radius:8px;background:var(--bg);font-size:0.85rem;color:var(--text);box-sizing:border-box}
.search-box input:focus{border-color:var(--purple-400);outline:none;box-shadow:0 0 0 3px var(--purple-100)}
</style>

<script>
    function setFilter(status) {
        document.getElementById('statusFilter').value = status;
        filterAll();
    }

    function filterAll() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const company = document.getElementById('companyFilter').value.toLowerCase();
        const status = document.getElementById('statusFilter').value.toLowerCase();
        let visible = 0;

        document.querySelectorAll('.pos-row').forEach(row => {
            const rs = (row.dataset.status || '').toLowerCase();
            const rc = (row.dataset.company || '').toLowerCase();
            const rt = (row.dataset.text || row.textContent).toLowerCase();
            const ok = (!search || rt.includes(search))
                     && (!company || rc === company)
                     && (!status || rs === status);
            row.style.display = ok ? '' : 'none';
            if (ok) visible++;
        });

        // Hide store block if all rows hidden
        document.querySelectorAll('.store-block').forEach(sb => {
            const anyVisible = Array.from(sb.querySelectorAll('.pos-row')).some(r => r.style.display !== 'none');
            sb.style.display = anyVisible ? '' : 'none';
        });

        // Hide company block if all stores hidden
        document.querySelectorAll('.company-block').forEach(cb => {
            const bc = (cb.dataset.company || '').toLowerCase();
            const anyVisible = Array.from(cb.querySelectorAll('.store-block')).some(s => s.style.display !== 'none');
            cb.style.display = (!company || bc === company) && anyVisible ? '' : 'none';
        });

        document.getElementById('resultSummary').textContent = 'แสดง ' + visible + ' เครื่อง';
    }

    document.getElementById('searchInput').addEventListener('input', filterAll);
    document.getElementById('companyFilter').addEventListener('change', filterAll);
    document.getElementById('statusFilter').addEventListener('change', filterAll);
    filterAll();
</script>
